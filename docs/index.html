
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gema Faucet</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #0f0c29; background-image: linear-gradient(to right top, #0c0a1e, #1d173a, #332258, #4c2c78, #6a359a); color: #e0e0e0; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .container { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.2); padding: 40px; border-radius: 20px; text-align: center; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); min-width: 400px; }
        .logo { width: 80px; height: 80px; margin-bottom: 20px; }
        h1 { color: #ffffff; font-weight: 600; margin-top: 0; }
        p { color: #d1c4e9; }
        button { background-image: linear-gradient(to right, #6a359a 0%, #a450c3 51%, #6a359a 100%); color: white; border: none; padding: 15px 30px; font-size: 16px; font-weight: 600; border-radius: 10px; cursor: pointer; transition: 0.5s; background-size: 200% auto; margin-top: 20px; text-transform: uppercase; display: block; margin-left: auto; margin-right: auto; }
        button:hover { background-position: right center; box-shadow: 0 0 20px #6a359a; }
        button:disabled { background-image: none; background-color: #333; color: #888; cursor: not-allowed; box-shadow: none; }
        #status { margin-top: 20px; font-size: 14px; min-height: 20px; color: #cfcfcf; }
        #countdown { font-size: 16px; font-weight: 600; color: #fdd835; margin-top: 15px; }
        #userBalanceText { font-size: 18px; color: white; font-weight: 600; }
    </style>
    
    <script src="https://js.hcaptcha.com/1/api.js" async defer></script>
</head>
<body>

    <div class="container">
        <img src="./logo.png" alt="Logo de Gema" class="logo">
        <h1>Gema Faucet</h1>
        <p id="userBalanceText">Conecta tu billetera para ver tu saldo.</p>
        
        <button id="connectButton">Conectar Billetera</button>

        <div id="actionArea" style="display: none;">
            <div class="h-captcha" 
                 data-sitekey="96d22f9a-78a8-4c16-88c2-470c2526cca8">
                 </div>
            
            <button id="claimButton">Acumular Recompensa</button>
            <button id="withdrawButton" disabled>Retirar Saldo (Próximamente)</button>
            <div id="countdown"></div>
        </div>
        
        <div id="status"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.2.0/dist/ethers.umd.min.js"></script>
    <script>
        // --- CONFIGURACIÓN: ¡DEBES RELLENAR ESTO! ---
        const backendUrl = "https://9edc7acc-018f-45b2-9761-d9a9ce5ce261-00-2m11yzpi2xiuj.picard.replit.dev/";
        // ---------------------------------------------

        const connectButton = document.getElementById('connectButton');
        const actionArea = document.getElementById('actionArea');
        const claimButton = document.getElementById('claimButton');
        const statusDiv = document.getElementById('status');
        const userBalanceText = document.getElementById('userBalanceText');
        const countdownDiv = document.getElementById('countdown');

        let userAddress;
        let countdownInterval;

        async function updateUI() {
    // ... (código igual que antes)
    // Solo asegúrate de que el botón de retiro se active
    if (data.balance >= WITHDRAWAL_MIN_FROM_SERVER) { // Necesitarás obtener WITHDRAWAL_MIN del servidor
        withdrawButton.disabled = false;
    } else {
        withdrawButton.disabled = true;
    }
}

        connectButton.addEventListener('click', async () => {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    userAddress = accounts[0];
                    
                    connectButton.style.display = 'none';
                    actionArea.style.display = 'block';
                    statusDiv.textContent = `Conectado: ${userAddress.substring(0, 6)}...${userAddress.substring(userAddress.length - 4)}`;
                    await updateUI();
                } catch (error) { 
                    statusDiv.textContent = "Conexión rechazada por el usuario.";
                    console.error(error);
                }
            } else { 
                statusDiv.textContent = "MetaMask no está instalado."; 
            }
        });

        claimButton.addEventListener('click', async () => {
            const captchaResponse = hcaptcha.getResponse();
            if (!captchaResponse) {
                statusDiv.textContent = "Por favor, completa el captcha primero.";
                return;
            }

            claimButton.disabled = true;
            statusDiv.textContent = "Procesando reclamo...";
            try {
                const response = await fetch(`${backendUrl}/claim`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        address: userAddress,
                        captcha: captchaResponse // Enviamos el captcha para verificación (paso futuro en el server)
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    statusDiv.textContent = "¡Recompensa acumulada con éxito!";
                } else {
                    statusDiv.textContent = `Error: ${data.error}`;
                }
                await updateUI();
            } catch (error) {
                console.error("Error claiming:", error);
                statusDiv.textContent = "Error de comunicación con el servidor.";
                claimButton.disabled = false;
            } finally {
                hcaptcha.reset(); // Resetea el captcha después del intento
            }
        });
        withdrawButton.addEventListener('click', async () => {
    withdrawButton.disabled = true;
    statusDiv.textContent = "Procesando retiro, por favor espera...";
    try {
        const response = await fetch(`${backendUrl}/withdraw`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ address: userAddress })
        });
        const data = await response.json();
        if (response.ok) {
            statusDiv.innerHTML = `¡Retiro en proceso! <a href="https://bscscan.com/tx/${data.txHash}" target="_blank">Ver transacción</a>`;
        } else {
            statusDiv.textContent = `Error: ${data.error}`;
        }
        await updateUI();
    } catch (error) {
        console.error("Error withdrawing:", error);
        statusDiv.textContent = "Error de comunicación con el servidor.";
    }
});
    </script>
</body>
</html>


